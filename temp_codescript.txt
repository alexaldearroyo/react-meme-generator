// src/App.js:

import './App.css';
import React, { useEffect, useState } from 'react';
import ActionsContainer from './ActionsContainer';
import MemeDisplay from './MemeDisplay';

function App() {
  // Component States
  const [showImage, setShowImage] = useState(true);
  const [imageUrl, setImageUrl] = useState(
    'https://api.memegen.link/images/doge/Hello/World.png',
  );
  const [errorMessage, setErrorMessage] = useState('');
  const [templates, setTemplates] = useState([]);

  // Effect for fetching meme templates
  useEffect(() => {
    fetch('https://api.memegen.link/templates/')
      .then((response) => response.json())
      .then((data) => {
        const templateNames = data.map((template) => template.id);
        setTemplates(templateNames);
      })
      .catch((error) => {
        console.error('Error fetching templates:', error);
      });
  }, []);

  // Show Meme Image
  const handleShowImage = (templateName, topText, bottomText) => {
    if (templates.includes(templateName)) {
      const newImageUrl = `https://api.memegen.link/images/${templateName}/${topText}/${bottomText}.png`; // URL interpolation
      setImageUrl(newImageUrl);
      setShowImage(true);
      setErrorMessage('');
    } else {
      setShowImage(false);
      setErrorMessage('Template id not found');
    }
  };

  return (
    <div className="App">
      <div className="container">
        <MemeDisplay
          showImage={showImage}
          imageUrl={imageUrl}
          errorMessage={errorMessage}
        />
        <ActionsContainer setShowImage={handleShowImage} imageUrl={imageUrl} />
      </div>
    </div>
  );
}

export default App;

----------------------------------------

// src/ActionsContainer.js:

import './ActionsContainer.css';
import React, { useEffect, useState } from 'react';
import TemplateSelector from './TemplateSelector';
import TextGenerator from './TextGenerator';

const ActionsContainer = ({ setShowImage, imageUrl }) => {
  const [inputText, setInputText] = useState('doge');
  const [topText, setTopText] = useState('Hello');
  const [bottomText, setBottomText] = useState('World');

  useEffect(() => {
    const encodedTopText = encodeURIComponent(topText);
    const encodedBottomText = encodeURIComponent(bottomText);
    setShowImage(inputText, encodedTopText, encodedBottomText);
  }, [inputText, topText, bottomText, setShowImage]);

  const handleDownloadClick = async () => {
    if (!imageUrl) return;

    try {
      const response = await fetch(imageUrl);
      if (!response.ok) {
        throw new Error('Failed to fetch image');
      }

      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.href = url;
      link.download = 'meme.png';
      link.style.display = 'none';

      document.body.appendChild(link);
      link.click();

      window.URL.revokeObjectURL(url);
      document.body.removeChild(link);
    } catch (error) {
      console.error('Error downloading image:', error);
    }
  };

  return (
    <div className="actions-container">
      <TemplateSelector
        inputText={inputText}
        handleInputChange={(e) => setInputText(e.target.value)}
      />
      <TextGenerator
        topText={topText}
        handleTopTextChange={(e) => setTopText(e.target.value)}
        bottomText={bottomText}
        handleBottomTextChange={(e) => setBottomText(e.target.value)}
        handleGenerateClick={() => setShowImage(inputText, topText, bottomText)}
        handleDownloadClick={handleDownloadClick}
        imageUrl={imageUrl}
      />
    </div>
  );
};

export default ActionsContainer;

----------------------------------------

// src/TextGenerator.js:

// src/TextGenerator.js

import './TextGenerator.css';
import React from 'react';

const TextRow = ({ label, id, value, handleChange }) => (
  <div className={`${id}-container`}>
    <label htmlFor={id} className={`${id}-label`}>
      {label}
    </label>
    <input
      id={id}
      placeholder={`Enter ${label.toLowerCase()}`}
      value={value}
      onChange={handleChange}
    />
  </div>
);

const TextGenerator = ({
  topText,
  handleTopTextChange,
  bottomText,
  handleBottomTextChange,
  handleGenerateClick,
  handleDownloadClick,
  // imageUrl,
}) => {
  return (
    <div className="text-generator-container common-width">
      <TextRow
        label="Top text"
        id="top-text"
        value={topText}
        handleChange={handleTopTextChange}
      />
      <TextRow
        label="Bottom text"
        id="bottom-text"
        value={bottomText}
        handleChange={handleBottomTextChange}
      />
      <div className="button-container">
        <button className="text-button" onClick={handleGenerateClick}>
          Generate
        </button>
        <button className="text-button" onClick={handleDownloadClick}>
          Download
        </button>
      </div>
    </div>
  );
};

export default TextGenerator;

----------------------------------------

// src/MemeDisplay.js:

import './MemeDisplay.css';
import React from 'react';

const MemeDisplay = ({ showImage, imageUrl, errorMessage }) => (
  <div className="meme-display">
    {showImage && (
      <img
        className="meme-image"
        src={String(imageUrl)}
        alt={`${String(imageUrl)} meme`}
        data-test-id="meme-image"
      />
    )}
    {Boolean(errorMessage) && (
      <div className="error-message">{errorMessage}</div>
    )}
  </div>
);

export default MemeDisplay;

----------------------------------------

// src/TemplateSelector.js:

import './TemplateSelector.css';
import React from 'react';

const SelectorText = ({ value, onChange }) => {
  return (
    <input
      className="selector-text"
      placeholder="Enter Template ID"
      value={value}
      onChange={onChange}
    />
  );
};

const SelectorButton = ({ onClick }) => {
  return (
    <button className="selector-button" onClick={onClick}>
      Show Template
    </button>
  );
};

const TemplateSelector = ({
  inputText,
  handleInputChange,
  handleButtonClick,
}) => {
  return (
    <div className="template-selector-container">
      <label htmlFor="template-id" className="template-label">
        Meme template
      </label>
      <div className="template-selector common-width">
        <SelectorText value={inputText} onChange={handleInputChange} />
        <SelectorButton onClick={handleButtonClick} />
      </div>
    </div>
  );
};

export default TemplateSelector;

----------------------------------------

